$(document).ready(function(){
    var crid = $("#crid").val();
    if($("#updateCareer").length>=1){
        function validateEditor() {
            // Revalidate the content when its value is changed by Summernote
            $('#summernoteForm').formValidation('revalidateField', 'content');
        }
        $('#updateCareer').formValidation({
            framework: 'bootstrap',
            icon: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            excluded: ':disabled',
            fields: {

                information: {
                    validators: {
                        callback: {
                            message: 'El contenido es obligatorio y no puede estar vacío',
                            callback: function(value, validator, $field) {
                                var code = $('[name="information"]').code();
                                // <p><br></p> is code generated by Summernote for empty content
                                return (code !== '' && code !== '<p><br></p>');
                            }
                        }
                    }
                },
                question: {
                    validators: {
                        callback: {
                            message: 'El contenido es obligatorio y no puede estar vacío',
                            callback: function(value, validator, $field) {
                                var code = $('[name="question"]').code();
                                // <p><br></p> is code generated by Summernote for empty content
                                return (code !== '' && code !== '<p><br></p>');
                            }
                        }
                    }
                }
            }
        }).on('success.form.fv', function(e) {
            e.preventDefault();
            $("#btn-submit").attr("disabled","disabled").val("Iniciando");
            $("#message-box-info").toggleClass("open");
            var values = {
                information:$('.summercareers').code(),
                question:$('.summercareers2').code()
            };
            var data = $(this).serialize()+"&"+jQuery.param(values);
            $.ajax({
                type : "POST",
                url : "update",
                data : data,
                dataType : "json",
                success : function(response){
                    if(response.message=="SUCCESS" && response.code==200){
                        $("#message-box-info").removeClass("open");
                        $("#message-box-success").toggleClass("open");
                        setTimeout(function(){
                            $("#message-box-success").removeClass("open");
                        },3000);
                    }else if(response.code==404){
                        $("#message-box-info").removeClass("open");
                        $("#message-box-warning").toggleClass("open");
                    }
                },
                error : function(){
                    $("#message-box-info").removeClass("open");
                }
            });
        });
    }
    if($("#sendMailPersonal").length>=1){
        Dropzone.autoDiscover = false;
        var myDropzone = new Dropzone('#sendMailPersonal', {
            url: "/dashboard/careers/uploadfile",
            uploadMultiple : true,
            paramName: "file",
            maxFilesize: 15,
            maxFiles: 2 ,
            parallelUploads : 1,
            addRemoveLinks : true,
            dictResponseError: "No se puede subir esta archivo!",
            autoProcessQueue: true,
            thumbnailWidth: 138,
            thumbnailHeight: 120,
            previewTemplate: '<div class="dz-preview dz-file-preview"><div class="dz-details"><div class="dz-filename"><span data-dz-name style=font-weight: bold;"></span></div><div class="dz-size"><span data-dz-size></span></div></div><div class="dz-error-message"><span data-dz-errormessage></span></div><div class="progress progress-striped active"><div class="progress-bar progress-bar-success" data-dz-uploadprogress></div></div></div>',
            resize: function(file) {
                var info = { srcX: 0, srcY: 0, srcWidth: file.width, srcHeight: file.height },
                    srcRatio = file.width / file.height;
                if (file.height > this.options.thumbnailHeight || file.width > this.options.thumbnailWidth) {
                    info.trgHeight = this.options.thumbnailHeight;
                    info.trgWidth = info.trgHeight * srcRatio;
                    if (info.trgWidth > this.options.thumbnailWidth) {
                        info.trgWidth = this.options.thumbnailWidth;
                        info.trgHeight = info.trgWidth / srcRatio;
                    }
                } else {
                    info.trgHeight = file.height;
                    info.trgWidth = file.width;
                }
                return info;
            },
            sending : function(file, xhr, formData){
                formData.append("crid",crid);
            },
            success: function(file, response){
                var values= response;
                if(values.code=="200"){
                    $(".dz-preview").addClass("dz-success");
                    $("div.progress").remove();
                    file.previewElement.accessKey = values.id;
                    $("#files").append(values.route);
                    alertMessage("success",values.message);
                }else{
                    alertMessage("warning",values.message);
                }
            },
            removedfile: function(file) {
                id = file.previewElement.accessKey;
                name = file.previewElement.id;
                $.ajax({
                    url: "/dashboard/careers/deletedfile",
                    type: "post",
                    data: {name:name,crid:crid},
                    dataType:"json",
                    success : function(response){
                        if(response.code=="200"){
                            alertMessage("success","Imagen eliminada correctamente");
                        }else{
                            alertMessage("warning","La imagen no se ha eliminado de la base de datos");
                        }
                        $(file.previewElement).remove();
                    },
                    error : function(){
                        alert("Ha ocurrido un error");
                    }
                });
            }
        });
        value = $('input[name="files"]').val();
        var mockFile = { name: "Click para remover la imagen", size: 12345};
        myDropzone.emit("addedfile",mockFile);
        myDropzone.element.lastChild.accessKey = value;
        /*image_load = "/api/images/careers/"+crid+"/file/"+value;*/
            image_load = "/api/images/icon.png";


        myDropzone.emit("thumbnail", mockFile,image_load);
        var existingFileCount = 1; // The number of files already uploaded
        myDropzone.options.maxFiles = myDropzone.options.maxFiles - existingFileCount;
    }
    deleteRow("deleteRow","/dashboard/careers/delete");
});
function deleteRow(selector,url){
    var box = $("#mb-remove-row");
    var id = "0";
    $(document.body).on("click","table tbody tr td a."+selector,function(e){
        e.preventDefault();
        id = $(this).attr("data-id");
        box.addClass("open");
    });
    box.find(".mb-control-yes").on("click",function(){
        $.ajax({
            url : url,
            type : "POST",
            data : {id:id},
            dataType : "json",
            success : function(response){
                box.removeClass("open");
                if(response.code==200){
                    $("."+id).hide("slow",function(){
                        $(this).remove();
                    });
                }else if(response.code==404){
                    messages(2,response.message);
                }else{
                    $("#message-box-danger-deleted").toggleClass("open");
                    setTimeout(function(){
                        $("#message-box-danger-deleted").removeClass("open");
                    },2000);
                }
            },error : function(){
                alert("Ha ocurrido un error intente nuevamente.");
            }
        });
    });
}